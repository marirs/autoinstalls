# PostgreSQL Performance Monitoring Configuration
# Monitoring and performance tuning for PostgreSQL

# Enable performance monitoring in postgresql.conf
# Add these settings to postgresql.conf:

# Query logging
log_min_duration_statement = 1000          # Log queries that take longer than 1 second
log_checkpoints = on                       # Log checkpoints
log_connections = on                       # Log connections
log_disconnections = on                    # Log disconnections
log_lock_waits = on                        # Log lock waits
log_temp_files = 10MB                      # Log temporary files larger than 10MB

# Performance monitoring
track_activities = on                      # Track database activities
track_counts = on                          # Track row-level statistics
track_io_timing = on                       # Track I/O timing
track_functions = all                      # Track function calls
track_activity_query_size = 1024            # Size of query text to track

# Statistics collection
shared_preload_libraries = pg_stat_statements  # Load pg_stat_statements extension
pg_stat_statements.max = 10000              # Maximum number of statements tracked
pg_stat_statements.track = all              # Track all statements
pg_stat_statements.track_utility = on       # Track utility commands

# Performance monitoring queries
# Connect to PostgreSQL and run these queries to get performance metrics

# 1. Database statistics
SELECT 
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    tup_returned,
    tup_fetched,
    tup_inserted,
    tup_updated,
    tup_deleted
FROM pg_stat_database 
WHERE datname != 'template0' AND datname != 'template1';

# 2. Table statistics
SELECT 
    schemaname,
    tablename,
    seq_scan,
    seq_tup_read,
    idx_scan,
    idx_tup_fetch,
    n_tup_ins,
    n_tup_upd,
    n_tup_del,
    n_tup_hot_upd,
    n_live_tup,
    n_dead_tup
FROM pg_stat_user_tables;

# 3. Index statistics
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes;

# 4. Slow queries (from pg_stat_statements)
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows,
    100.0 * shared_blks_hit / nullif(shared_blks_hit + shared_blks_read, 0) AS hit_percent
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 10;

# 5. Lock information
SELECT 
    t.relname AS table_name,
    l.locktype,
    l.mode,
    l.granted,
    a.query AS waiting_query
FROM pg_locks l
JOIN pg_stat_activity a ON l.pid = a.pid
JOIN pg_class t ON l.relation = t.oid
WHERE NOT l.granted;

# 6. Connection information
SELECT 
    datname,
    pid,
    usename,
    application_name,
    client_addr,
    state,
    query_start,
    state_change,
    query
FROM pg_stat_activity 
WHERE state != 'idle';

# 7. Database size
SELECT 
    datname,
    pg_size_pretty(pg_database_size(datname)) AS size
FROM pg_database 
WHERE datname != 'template0' AND datname != 'template1'
ORDER BY pg_database_size(datname) DESC;

# 8. Table size
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS total_size,
    pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) AS table_size,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename) - pg_relation_size(schemaname||'.'||tablename)) AS index_size
FROM pg_tables 
WHERE schemaname NOT IN ('information_schema', 'pg_catalog')
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

# 9. Index usage
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch,
    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size
FROM pg_stat_user_indexes 
ORDER BY idx_scan DESC;

# 10. Vacuum progress
SELECT 
    datname,
    relname,
    phase,
    heap_blks_total,
    heap_blks_scanned,
    heap_blks_vacuumed,
    index_vacuum_count,
    dead_tuple_count
FROM pg_stat_progress_vacuum;

# Performance monitoring script example:
# Save as monitor-postgresql.sh

#!/bin/bash
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432"
POSTGRES_USER="postgres"

# Get database statistics
echo "=== PostgreSQL Database Statistics ==="
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -c "
SELECT 
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit,
    100.0 * blks_hit / nullif(blks_hit + blks_read, 0) AS cache_hit_ratio
FROM pg_stat_database 
WHERE datname != 'template0' AND datname != 'template1';" --quiet

# Get slow queries
echo -e "\n=== Slow Queries ==="
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -c "
SELECT 
    left(query, 50) AS query,
    calls,
    round(mean_time::numeric, 2) AS mean_time_ms,
    round(total_time::numeric, 2) AS total_time_ms
FROM pg_stat_statements 
ORDER BY mean_time DESC 
LIMIT 5;" --quiet

# Get active connections
echo -e "\n=== Active Connections ==="
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -c "
SELECT 
    datname,
    count(*) AS active_connections
FROM pg_stat_activity 
WHERE state = 'active'
GROUP BY datname;" --quiet

# Get lock information
echo -e "\n=== Lock Information ==="
psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -c "
SELECT 
    t.relname AS table_name,
    l.locktype,
    l.mode,
    COUNT(*) AS lock_count
FROM pg_locks l
JOIN pg_class t ON l.relation = t.oid
WHERE NOT l.granted
GROUP BY t.relname, l.locktype, l.mode;" --quiet

# Alert thresholds (adjust as needed)
CONNECTIONS_THRESHOLD=50
SLOW_QUERY_THRESHOLD=1000
LOCK_WAIT_THRESHOLD=5

# Check alerts
echo -e "\n=== Performance Alerts ==="

# Check connection count
ACTIVE_CONNECTIONS=$(psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -t -c "
SELECT COUNT(*) FROM pg_stat_activity WHERE state = 'active';" --quiet)
if [ "$ACTIVE_CONNECTIONS" -gt "$CONNECTIONS_THRESHOLD" ]; then
    echo "ALERT: High active connection count: $ACTIVE_CONNECTIONS"
fi

# Check slow queries
SLOW_QUERIES=$(psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -t -c "
SELECT COUNT(*) FROM pg_stat_statements WHERE mean_time > $SLOW_QUERY_THRESHOLD;" --quiet)
if [ "$SLOW_QUERIES" -gt 0 ]; then
    echo "ALERT: $SLOW_QUERIES slow queries detected (>$SLOW_QUERY_THRESHOLD ms)"
fi

# Check lock waits
LOCK_WAITS=$(psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -d postgres -t -c "
SELECT COUNT(*) FROM pg_locks WHERE NOT granted;" --quiet)
if [ "$LOCK_WAITS" -gt "$LOCK_WAIT_THRESHOLD" ]; then
    echo "ALERT: $LOCK_WAITS lock waits detected"
fi
