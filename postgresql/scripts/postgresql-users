# PostgreSQL User Management Script
# Create and manage PostgreSQL users with proper roles and permissions

#!/bin/bash

# Configuration
POSTGRES_USER="postgres"
POSTGRES_HOST="localhost"
POSTGRES_PORT="5432"

# Colors
CSI="\033["
CEND="${CSI}0m"
CRED="${CSI}1;31m"
CGREEN="${CSI}1;32m"
CYELLOW="${CSI}1;33m"

# Function to create superuser
create_superuser() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: $0 create-superuser <username> <password>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    
    echo "Creating PostgreSQL superuser: $USERNAME"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "CREATE USER \"$USERNAME\" WITH SUPERUSER PASSWORD '$PASSWORD';"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Superuser created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create superuser${CEND}"
        exit 1
    fi
}

# Function to create application user
create_app_user() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: $0 create-app <username> <password> <database>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    DATABASE="$3"
    
    echo "Creating application user: $USERNAME for database: $DATABASE"
    
    # Create user
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "CREATE USER \"$USERNAME\" WITH PASSWORD '$PASSWORD';"
    
    # Grant privileges
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT CONNECT ON DATABASE \"$DATABASE\" TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT USAGE ON SCHEMA public TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT CREATE ON SCHEMA public TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO \"$USERNAME\";"
    
    # Set default privileges for future tables
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO \"$USERNAME\";"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Application user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create application user${CEND}"
        exit 1
    fi
}

# Function to create read-only user
create_readonly_user() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: $0 create-readonly <username> <password> <database>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    DATABASE="$3"
    
    echo "Creating read-only user: $USERNAME for database: $DATABASE"
    
    # Create user
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "CREATE USER \"$USERNAME\" WITH PASSWORD '$PASSWORD';"
    
    # Grant read-only privileges
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT CONNECT ON DATABASE \"$DATABASE\" TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT USAGE ON SCHEMA public TO \"$USERNAME\";"
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT SELECT ON ALL TABLES IN SCHEMA public TO \"$USERNAME\";"
    
    # Set default privileges for future tables
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO \"$USERNAME\";"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Read-only user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create read-only user${CEND}"
        exit 1
    fi
}

# Function to create backup user
create_backup_user() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: $0 create-backup <username> <password>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    
    echo "Creating backup user: $USERNAME"
    
    # Create user with replication privileges
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "CREATE USER \"$USERNAME\" WITH REPLICATION PASSWORD '$PASSWORD';"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Backup user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create backup user${CEND}"
        exit 1
    fi
}

# Function to list all users
list_users() {
    echo "Listing PostgreSQL users..."
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "
SELECT 
    usename as username,
    usesuper as superuser,
    usecreatedb as create_db,
    userepl as replication,
    usebypassrls as bypass_rls,
    passwduntil as password_expiry
FROM pg_user 
ORDER BY usename;"
}

# Function to delete user
delete_user() {
    if [ -z "$1" ]; then
        echo "Usage: $0 delete <username>"
        exit 1
    fi
    
    USERNAME="$1"
    
    echo "Deleting user: $USERNAME"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "DROP USER IF EXISTS \"$USERNAME\";"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}User deleted successfully${CEND}"
    else
        echo -e "${CRED}Failed to delete user${CEND}"
        exit 1
    fi
}

# Function to change user password
change_password() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: $0 password <username> <new_password>"
        exit 1
    fi
    
    USERNAME="$1"
    NEW_PASSWORD="$2"
    
    echo "Changing password for user: $USERNAME"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "ALTER USER \"$USERNAME\" WITH PASSWORD '$NEW_PASSWORD';"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Password changed successfully${CEND}"
    else
        echo -e "${CRED}Failed to change password${CEND}"
        exit 1
    fi
}

# Function to check user permissions
check_user_permissions() {
    if [ -z "$1" ]; then
        echo "Usage: $0 check <username>"
        exit 1
    fi
    
    USERNAME="$1"
    
    echo "Checking permissions for user: $USERNAME"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "
SELECT 
    schemaname,
    tablename,
    hasinsert,
    hasselect,
    hasupdate,
    hasdelete,
    hastruncate,
    hastrigger,
    hasreferences
FROM pg_tables t
LEFT JOIN (
    SELECT 
        schemaname,
        tablename,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'INSERT') as hasinsert,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'SELECT') as hasselect,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'UPDATE') as hasupdate,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'DELETE') as hasdelete,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'TRUNCATE') as hastruncate,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'TRIGGER') as hastrigger,
        has_table_privilege('$USERNAME', schemaname||'.'||tablename, 'REFERENCES') as hasreferences
    FROM pg_tables
) p ON t.schemaname = p.schemaname AND t.tablename = p.tablename
WHERE t.schemaname = 'public'
ORDER BY t.tablename;"
}

# Function to grant specific privileges
grant_privileges() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
        echo "Usage: $0 grant <username> <database> <schema> <privileges>"
        echo "Privileges: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, ALL"
        exit 1
    fi
    
    USERNAME="$1"
    DATABASE="$2"
    SCHEMA="$3"
    PRIVILEGES="$4"
    
    echo "Granting $PRIVILEGES to user $USERNAME on $DATABASE.$SCHEMA"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "GRANT $PRIVILEGES ON ALL TABLES IN SCHEMA $SCHEMA TO \"$USERNAME\";"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Privileges granted successfully${CEND}"
    else
        echo -e "${CRED}Failed to grant privileges${CEND}"
        exit 1
    fi
}

# Function to revoke privileges
revoke_privileges() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
        echo "Usage: $0 revoke <username> <database> <schema> <privileges>"
        echo "Privileges: SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER, ALL"
        exit 1
    fi
    
    USERNAME="$1"
    DATABASE="$2"
    SCHEMA="$3"
    PRIVILEGES="$4"
    
    echo "Revoking $PRIVILEGES from user $USERNAME on $DATABASE.$SCHEMA"
    
    psql -h $POSTGRES_HOST -p $POSTGRES_PORT -U $POSTGRES_USER -c "REVOKE $PRIVILEGES ON ALL TABLES IN SCHEMA $SCHEMA FROM \"$USERNAME\";"
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Privileges revoked successfully${CEND}"
    else
        echo -e "${CRED}Failed to revoke privileges${CEND}"
        exit 1
    fi
}

# Main script logic
case "$1" in
    "create-superuser")
        create_superuser "$2" "$3"
        ;;
    "create-app")
        create_app_user "$2" "$3" "$4"
        ;;
    "create-readonly")
        create_readonly_user "$2" "$3" "$4"
        ;;
    "create-backup")
        create_backup_user "$2" "$3"
        ;;
    "list")
        list_users
        ;;
    "delete")
        delete_user "$2"
        ;;
    "password")
        change_password "$2" "$3"
        ;;
    "check")
        check_user_permissions "$2"
        ;;
    "grant")
        grant_privileges "$2" "$3" "$4" "$5"
        ;;
    "revoke")
        revoke_privileges "$2" "$3" "$4" "$5"
        ;;
    *)
        echo "PostgreSQL User Management Script"
        echo "Usage: $0 {command} [arguments]"
        echo ""
        echo "Commands:"
        echo "  create-superuser <user> <pass>       Create superuser"
        echo "  create-app <user> <pass> <db>         Create application user"
        echo "  create-readonly <user> <pass> <db>    Create read-only user"
        echo "  create-backup <user> <pass>           Create backup user"
        echo "  list                                 List all users"
        echo "  delete <username>                     Delete user"
        echo "  password <username> <new_pass>        Change user password"
        echo "  check <username>                      Check user permissions"
        echo "  grant <user> <db> <schema> <privs>     Grant privileges"
        echo "  revoke <user> <db> <schema> <privs>    Revoke privileges"
        echo ""
        echo "Examples:"
        echo "  $0 create-superuser admin password123"
        echo "  $0 create-app webapp password123 myapp"
        echo "  $0 create-readonly reader password123 myapp"
        echo "  $0 create-backup backup backup123"
        echo "  $0 list"
        echo "  $0 delete webapp"
        echo "  $0 password webapp newpassword"
        echo "  $0 check webapp"
        echo "  $0 grant webapp myapp public SELECT,INSERT"
        echo "  $0 revoke webapp myapp public DELETE"
        exit 1
        ;;
esac
