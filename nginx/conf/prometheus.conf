# Prometheus Metrics Configuration
# Exposes nginx metrics for Prometheus monitoring

# Prometheus metrics endpoint
server {
    listen 127.0.0.1:9113;
    server_name localhost;
    
    # Prometheus metrics endpoint
    location /metrics {
        prometheus_exporter;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
    
    # Basic status page
    location /status {
        stub_status on;
        access_log off;
        allow 127.0.0.1;
        deny all;
    }
}

# Metrics available from nginx-prometheus-exporter:
# - nginx_connections_total: Total connections
# - nginx_requests_total: Total requests
# - nginx_request_duration_seconds: Request processing time
# - nginx_upstream_response_time_seconds: Upstream response time
# - nginx_bytes_sent: Bytes sent to clients
# - nginx_bytes_received: Bytes received from clients
# - nginx_ssl_handshakes_total: SSL handshake count
# - nginx_ssl_handshakes_failed_total: Failed SSL handshakes
# - nginx_http_responses_total: Response status codes
# - nginx_upstream_health_check_failures_total: Health check failures

# Grafana dashboard configuration:
# Use the official Nginx Prometheus Exporter dashboard
# Dashboard ID: 11199 (Nginx Prometheus Exporter)

# Example Prometheus configuration snippet:
# scrape_configs:
#   - job_name: 'nginx'
#     static_configs:
#       - targets: ['localhost:9113']
#     scrape_interval: 5s
#     metrics_path: /metrics

# Example alerting rules:
# groups:
# - name: nginx
#   rules:
#   - alert: NginxHighResponseTime
#     expr: nginx_request_duration_seconds{quantile="0.95"} > 1
#     for: 5m
#     labels:
#       severity: warning
#     annotations:
#       summary: "High nginx response time"
#       description: "95th percentile response time is {{ $value }}s"
#   
#   - alert: NginxDown
#     expr: up{job="nginx"} == 0
#     for: 1m
#     labels:
#       severity: critical
#     annotations:
#       summary: "Nginx exporter is down"
#       description: "Nginx Prometheus exporter has been down for more than 1 minute"

# Performance considerations:
# - Metrics collection has minimal performance impact
# - Consider increasing scrape interval for high-traffic sites
# - Monitor the exporter itself for resource usage
