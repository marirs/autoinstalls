# Perl Module Configuration
# Enables Perl scripting within nginx

# Perl script example for custom logic
location /perl/ {
    perl '
        my $r = shift;
        $r->send_http_header("Content-Type", "text/plain");
        $r->print("Hello from Perl!\n");
        $r->print("Request URI: " . $r->uri . "\n");
        $r->print("Method: " . $r->method . "\n");
        return OK;
    ';
}

# Advanced Perl handler for custom routing
location /api/v1/ {
    perl '
        my $r = shift;
        
        # Custom API versioning logic
        if ($r->uri =~ m|^/api/v(\d+)/(.*)|) {
            my $version = $1;
            my $path = $2;
            
            # Route based on version
            if ($version == 1) {
                $r->internal_redirect("/legacy_api/$path");
            } elsif ($version == 2) {
                $r->internal_redirect("/new_api/$path");
            } else {
                $r->send_http_header("Status", "400 Bad Request");
                $r->send_http_header("Content-Type", "application/json");
                $r->print('{"error": "Unsupported API version"}');
                return OK;
            }
        }
        
        return DECLINED;
    ';
}

# Request logging with Perl
location /log/ {
    perl '
        my $r = shift;
        
        # Custom logging logic
        my $log_file = "/var/log/nginx/custom.log";
        open my $fh, ">>", $log_file or return SERVER_ERROR;
        
        my $timestamp = scalar localtime;
        my $client_ip = $r->remote_addr;
        my $request_uri = $r->uri;
        
        print $fh "[$timestamp] $client_ip $request_uri\n";
        close $fh;
        
        $r->send_http_header("Content-Type", "text/plain");
        $r->print("Request logged\n");
        return OK;
    ';
}

# Content generation with Perl
location /generated/ {
    perl '
        my $r = shift;
        
        # Generate dynamic content
        $r->send_http_header("Content-Type", "application/json");
        
        my $data = {
            timestamp => time(),
            server => "nginx",
            version => "1.0",
            request_uri => $r->uri
        };
        
        # Simple JSON generation
        my $json = "{";
        foreach my $key (keys %$data) {
            $json .= qq{"$key": "$data->{$key}", };
        }
        $json =~ s/,$//;
        $json .= "}";
        
        $r->print($json);
        return OK;
    ';
}

# Perl module loading (if you have custom modules)
# perl_modules /etc/nginx/perl/lib;
# perl_require MyCustomModule.pm;

# Performance considerations:
# - Perl code runs for each request
# - Keep Perl code simple and fast
# - Consider using nginx variables for simple operations
# - Use external scripts for complex logic

# Error handling:
# - Use eval {} for error handling
# - Check return values
# - Log errors appropriately
