# Docker Security Configuration
# Internal-only Docker deployment with security hardening

## Docker Daemon Security Configuration
# File: /etc/docker/daemon.json

{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  },
  "storage-driver": "overlay2",
  "storage-opts": [
    "overlay2.override_kernel_check=true"
  ],
  "default-ulimits": {
    "nofile": {
      "Name": "nofile",
      "Hard": 64000,
      "Soft": 64000
    }
  },
  "userland-proxy": false,
  "experimental": false,
  "exec-opts": ["native.cgroupdriver=systemd"],
  "bridge": "docker0",
  "bip": "172.17.0.1/16",
  "fixed-cidr": "172.17.0.0/16",
  "mtu": 1500,
  "ip-forward": false,
  "iptables": false,
  "live-restore": true,
  "userns-remap": "default",
  "no-new-privileges": true,
  "seccomp-profile": "/etc/docker/seccomp.json",
  "default-runtime": "runc",
  "runtimes": {
    "runc": {
      "path": "runc",
      "runtimeArgs": [
        "--seccomp",
        "/etc/docker/seccomp.json"
      ]
    }
  },
  "registry-mirrors": [],
  "insecure-registries": [],
  "disable-legacy-registry": true,
  "max-concurrent-downloads": 3,
  "max-concurrent-uploads": 3,
  "max-download-attempts": 5,
  "data-root": "/var/lib/docker",
  "exec-root": "/var/run/docker",
  "hosts": [
    "unix:///var/run/docker.sock"
  ]
}

## Security Features Explained:

### 1. Network Security
- **ip-forward**: false - Prevents containers from accessing external networks
- **iptables**: false - Disables automatic iptables rules
- **bridge**: docker0 with fixed CIDR - Isolates Docker network
- **hosts**: unix socket only - No TCP daemon socket

### 2. User Security
- **userns-remap**: default - Maps container users to non-root host users
- **no-new-privileges**: true - Prevents privilege escalation
- **default-ulimits**: Sets resource limits

### 3. Runtime Security
- **seccomp-profile**: Restricts system calls
- **default-runtime**: runc with seccomp
- **userland-proxy**: false - Disables userland proxy

### 4. Storage Security
- **storage-driver**: overlay2 with kernel check override
- **log-opts**: Limits log size and rotation

## Internal Network Configuration

### Bridge Network
```bash
# Internal bridge network
docker network create --driver bridge --internal --subnet=172.18.0.0/16 internal-net
```

### Container Network Policy
- All containers use internal network by default
- No external internet access
- Inter-container communication allowed
- Host access restricted

## Firewall Configuration

### UFW Rules
```bash
# Block external Docker access
ufw deny 2376/tcp  # Docker daemon
ufw deny 2377/tcp  # Docker daemon (if needed)

# Allow localhost only
ufw allow from 127.0.0.1 to any port 2376
ufw allow from 172.16.0.0/12 to any port 2376
ufw allow from 172.17.0.0/16 to any port 2376
ufw allow from 172.18.0.0/16 to any port 2376
```

### iptables Rules (Alternative)
```bash
# Block external access to Docker daemon
iptables -A INPUT -p tcp --dport 2376 -s ! 127.0.0.1 -j DROP
iptables -A INPUT -p tcp --dport 2376 -s ! 172.16.0.0/12 -j DROP
iptables -A INPUT -p tcp --dport 2376 -s ! 172.17.0.0/16 -j DROP
iptables -A INPUT -p tcp --dport 2376 -s ! 172.18.0.0/16 -j DROP
```

## Container Security Best Practices

### 1. Minimal Base Images
```dockerfile
FROM alpine:3.18
# Use minimal base images
```

### 2. Non-Root User
```dockerfile
RUN addgroup -g 1001 appgroup && \
    adduser -D -s /bin/sh -u 1001 -G appgroup appuser
USER appuser
```

### 3. Read-Only Filesystem
```dockerfile
# Mount temporary directories as tmpfs
VOLUME ["/tmp"]
# Run with --read-only flag
```

### 4. Capability Dropping
```bash
docker run --cap-drop ALL --cap-add CHOWN --cap-add SETGID --cap-add SETUID
```

### 5. Security Options
```bash
docker run --security-opt no-new-privileges:true \
           --security-opt seccomp=default.json \
           --read-only \
           --tmpfs /tmp \
           --tmpfs /var/run
```

## Monitoring and Auditing

### 1. Container Monitoring
```bash
# Monitor container activity
docker stats --no-stream

# Check container processes
docker exec <container> ps aux

# View container logs
docker logs <container>
```

### 2. Security Auditing
```bash
# Check running containers
docker ps --format "table {{.Names}}\t{{.Image}}\t{{.Status}}"

# Inspect container security settings
docker inspect <container> | jq '.[0].HostConfig.SecurityOpt'

# Check network configuration
docker network ls
docker network inspect internal-net
```

### 3. Log Analysis
```bash
# Monitor Docker daemon logs
journalctl -u docker.service -f

# Check container logs for security events
docker logs <container> | grep -i "error\|warning\|denied"
```

## Troubleshooting

### Common Issues

1. **Container cannot access internet**
   - This is intentional - containers are internal-only
   - Use `--network=host` only if absolutely necessary

2. **Docker daemon not accessible**
   - Check if user is in docker group
   - Verify firewall rules
   - Check daemon logs

3. **Permission denied errors**
   - Log out and log back in for group changes
   - Check user namespace mapping

### Debug Commands
```bash
# Check Docker daemon status
systemctl status docker

# Test Docker installation
docker run --rm hello-world

# Check network configuration
docker network ls
docker network inspect bridge

# Verify firewall rules
ufw status verbose
iptables -L -n
```

## Security Checklist

### ✅ Pre-Installation
- [ ] System updated
- [ ] Firewall installed and configured
- [ ] User accounts created
- [ ] Security policies reviewed

### ✅ Installation
- [ ] Docker installed from official repository
- [ ] Security configuration applied
- [ ] Internal network created
- [ ] Firewall rules configured

### ✅ Post-Installation
- [ ] Docker services running
- [ ] User added to docker group
- [ ] Example containers tested
- [ ] Monitoring configured

### ✅ Ongoing
- [ ] Regular security updates
- [ ] Log monitoring
- [ ] Container image scanning
- [ ] Network traffic monitoring
- [ ] User access reviews

## Emergency Procedures

### Container Compromise
```bash
# Stop compromised container
docker stop <container>

# Remove container
docker rm <container>

# Check for other affected containers
docker ps -a

# Review logs
docker logs <container>

# Update affected images
docker pull --all <image>
```

### Security Incident
```bash
# Stop all containers
docker stop $(docker ps -q)

# Stop Docker daemon
systemctl stop docker

# Review logs
journalctl -u docker.service

# Check system integrity
# (Run system security tools)

# Restart services when safe
systemctl start docker
docker start $(docker ps -a -q)
```

## Compliance Notes

### Industry Standards
- **CIS Docker Benchmark**: Configuration aligns with CIS recommendations
- **NIST Cybersecurity Framework**: Implements access control and monitoring
- **GDPR**: Data processing within controlled environment
- **SOC 2**: Security controls for internal services

### Audit Trail
- All Docker actions logged to systemd journal
- Container logs retained per policy
- Network access logged via firewall
- User access logged via system auth

## Performance Considerations

### Resource Limits
```bash
# Set container memory limits
docker run --memory=512m --cpus=1.0 <image>

# Set disk space limits
docker run --storage-opt size=10G <image>
```

### Monitoring Metrics
- Container CPU usage
- Memory consumption
- Network I/O (internal only)
- Disk usage
- Container start/stop times

## Backup and Recovery

### Docker Data Backup
```bash
# Backup Docker volumes
docker run --rm -v /var/lib/docker:/data -v /backup:/backup alpine tar czf /backup/docker-backup.tar.gz -C /data .

# Backup container configurations
docker ps -a --format "table {{.Names}}\t{{.Image}}\t{{.Status}}" > /backup/container-list.txt
```

### Recovery Procedures
```bash
# Restore Docker data
docker run --rm -v /var/lib/docker:/data -v /backup:/backup alpine tar xzf /backup/docker-backup.tar.gz -C /data

# Restart Docker service
systemctl restart docker
```
