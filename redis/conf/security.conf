# Redis Security Configuration
# Localhost-only Redis deployment with comprehensive security hardening

## Redis Configuration File
# File: /etc/redis/redis.conf

# Network Configuration
bind 127.0.0.1 ::1
port 6379
protected-mode yes

# Security Configuration
requirepass <SECURE_PASSWORD>
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b8f3a2c7"
rename-command SHUTDOWN "SHUTDOWN_e9d4c5f1"
rename-command DEBUG ""
rename-command EVAL ""

# Memory Management
maxmemory 256mb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# Persistence Configuration
save 900 1
save 300 10
save 60 10000
stop-writes-on-bgsave-error yes
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOF Configuration
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb
aof-load-truncated yes
aof-use-rdb-preamble yes

# Security and Permissions
tcp-keepalive 300
timeout 0
tcp-backlog 511
supervised systemd

# Logging Configuration
loglevel notice
logfile /var/log/redis/redis-server.log
syslog-enabled yes
syslog-ident redis

# Client Configuration
maxclients 10000

# Slow Log Configuration
slowlog-log-slower-than 10000
slowlog-max-len 128

# Latency Monitoring
latency-monitor-threshold 100

# Event Notification Configuration
notify-keyspace-events ""

# Hash Configuration
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List Configuration
list-max-ziplist-size -2
list-compress-depth 0

# Set Configuration
set-max-intset-entries 512

# Sorted Set Configuration
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog Configuration
hll-sparse-max-bytes 3000

# Stream Configuration
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active Rehashing
activerehashing yes

# Client Output Buffer Limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Client Query Buffer Limit
client-query-buffer-limit 1gb

# Protocol Max Bulk Request Size
proto-max-bulk-len 512mb

# Frequency of Rehashing
hz 10

# AOF Rewrite Incremental Fsync
aof-rewrite-incremental-fsync yes

# RDB Save Incremental Fsync
rdb-save-incremental-fsync yes

## Security Features Explained:

### 1. Network Security
- **bind 127.0.0.1 ::1**: Redis only listens on localhost
- **protected-mode yes**: Additional layer of security
- **port 6379**: Standard Redis port (firewall protected)

### 2. Authentication Security
- **requirepass**: Password-based authentication
- **rename-command**: Dangerous commands disabled/renamed
- **FLUSHDB/FLUSHALL**: Disabled to prevent data deletion
- **KEYS**: Disabled to prevent performance issues
- **CONFIG**: Renamed to prevent configuration changes
- **SHUTDOWN**: Renamed to prevent unauthorized shutdowns
- **DEBUG**: Disabled to prevent debugging access
- **EVAL**: Disabled to prevent script execution

### 3. Memory Security
- **maxmemory 256mb**: Prevents memory exhaustion
- **maxmemory-policy allkeys-lru**: Evicts old keys when memory full
- **maxmemory-samples 5**: Sample size for LRU algorithm

### 4. Persistence Security
- **RDB snapshots**: Regular data persistence
- **AOF logging**: Append-only file for durability
- **Compression**: Reduces disk usage
- **Checksums**: Data integrity verification

### 5. Access Control
- **maxclients 10000**: Limits concurrent connections
- **timeout 0**: No idle timeout for persistent connections
- **tcp-keepalive 300**: Keeps connections alive

## Firewall Configuration

### UFW Rules
```bash
# Allow Redis from localhost only
ufw allow from 127.0.0.1 to any port 6379
ufw allow from ::1 to any port 6379

# Block external Redis access
ufw deny 6379/tcp
```

### iptables Rules (Alternative)
```bash
# Allow Redis from localhost only
iptables -A INPUT -p tcp --dport 6379 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 6379 -s ::1 -j ACCEPT

# Block external Redis access
iptables -A INPUT -p tcp --dport 6379 -j DROP
```

## Systemd Security Configuration

### Redis Service Security
```ini
[Unit]
Description=Redis In-Memory Data Store
After=network.target

[Service]
Type=notify
User=redis
Group=redis
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/var/lib/redis /var/log/redis /etc/redis
ProtectHome=true
RemoveIPC=true

# Network settings
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
IPAddressDeny=any
IPAddressAllow=localhost
IPAddressAllow=127.0.0.1/8
IPAddressAllow=::1/128

# File system settings
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true

# Memory settings
MemoryMax=512M

[Install]
WantedBy=multi-user.target
```

## Security Best Practices

### 1. Password Management
```bash
# Generate secure password
openssl rand -base64 32 | tr -d "=+/" | cut -c1-25

# Store password securely
chmod 600 /etc/redis/redis.passwd
chown redis:redis /etc/redis/redis.passwd
```

### 2. Connection Security
```bash
# Connect with authentication
redis-cli -a <PASSWORD>

# Test connection
redis-cli -a <PASSWORD> ping

# Use environment variable for password
export REDIS_PASSWORD=<PASSWORD>
redis-cli -a $REDIS_PASSWORD
```

### 3. Application Security
```python
# Python example with redis-py
import redis

# Secure connection with authentication
r = redis.Redis(
    host='localhost',
    port=6379,
    password='<PASSWORD>',
    decode_responses=True,
    socket_timeout=5,
    socket_connect_timeout=5
)

# Test connection
r.ping()
```

```javascript
// Node.js example with ioredis
const Redis = require('ioredis');

const redis = new Redis({
    host: 'localhost',
    port: 6379,
    password: '<PASSWORD>',
    connectTimeout: 5000,
    lazyConnect: true
});

// Test connection
redis.ping().then(console.log);
```

## Monitoring and Auditing

### 1. Connection Monitoring
```bash
# Monitor connected clients
redis-cli -a <PASSWORD> client list

# Monitor Redis operations
redis-cli -a <PASSWORD> monitor

# Check slow queries
redis-cli -a <PASSWORD> slowlog get 10
```

### 2. Security Monitoring
```bash
# Check authentication failures
grep "authentication" /var/log/redis/redis-server.log

# Monitor connection attempts
grep "Accepted" /var/log/redis/redis-server.log

# Check for blocked commands
grep "command" /var/log/redis/redis-server.log
```

### 3. Performance Monitoring
```bash
# Check memory usage
redis-cli -a <PASSWORD> info memory

# Check client connections
redis-cli -a <PASSWORD> info clients

# Check statistics
redis-cli -a <PASSWORD> info stats
```

## Backup and Recovery

### 1. Automated Backup
```bash
# Create backup script
#!/bin/bash
REDIS_PASSWORD=$(cat /etc/redis/redis.passwd)
BACKUP_DIR="/var/backups/redis"
DATE=$(date +%Y%m%d_%H%M%S)

# Trigger background save
redis-cli -a $REDIS_PASSWORD BGSAVE

# Wait for save to complete
while [ $(redis-cli -a $REDIS_PASSWORD LASTSAVE) -eq $(redis-cli -a $REDIS_PASSWORD LASTSAVE) ]; do
    sleep 1
done

# Copy backup files
cp /var/lib/redis/dump.rdb $BACKUP_DIR/dump_$DATE.rdb
cp /var/lib/redis/appendonly.aof $BACKUP_DIR/appendonly_$DATE.aof
gzip $BACKUP_DIR/dump_$DATE.rdb
gzip $BACKUP_DIR/appendonly_$DATE.aof
```

### 2. Restore Procedure
```bash
# Stop Redis service
systemctl stop redis

# Backup current data
cp /var/lib/redis/dump.rdb /var/lib/redis/dump.rdb.backup

# Restore from backup
gunzip -c /var/backups/redis/dump_YYYYMMDD_HHMMSS.rdb.gz > /var/lib/redis/dump.rdb
chown redis:redis /var/lib/redis/dump.rdb

# Start Redis service
systemctl start redis
```

## Security Checklist

### ✅ Pre-Installation
- [ ] System updated and patched
- [ ] Firewall installed and configured
- [ ] Redis user created with minimal privileges
- [ ] Secure password generated

### ✅ Installation
- [ ] Redis installed from source
- [ ] Security configuration applied
- [ ] Password authentication enabled
- [ ] Dangerous commands disabled
- [ ] Firewall rules configured
- [ ] Systemd security applied

### ✅ Post-Installation
- [ ] Redis service running and enabled
- [ ] Password authentication tested
- [ ] Localhost-only access verified
- [ ] Backup procedures tested
- [ ] Monitoring configured

### ✅ Ongoing Security
- [ ] Regular security updates applied
- [ ] Password rotation schedule
- [ ] Log monitoring for security events
- [ ] Backup verification
- [ ] Performance monitoring
- [ ] Access reviews

## Troubleshooting

### Common Security Issues

#### Authentication Failures
```bash
# Check if password is correct
redis-cli -a <PASSWORD> ping

# Check Redis logs for authentication errors
grep "authentication" /var/log/redis/redis-server.log

# Verify password file permissions
ls -la /etc/redis/redis.passwd
```

#### External Access Attempts
```bash
# Check firewall rules
ufw status verbose

# Check network connections
netstat -tlnp | grep 6379

# Check Redis configuration
grep "bind" /etc/redis/redis.conf
```

#### Performance Issues
```bash
# Check memory usage
redis-cli -a <PASSWORD> info memory

# Check slow queries
redis-cli -a <PASSWORD> slowlog get 10

# Check client connections
redis-cli -a <PASSWORD> info clients
```

## Emergency Procedures

### Security Incident Response
```bash
# Block external access immediately
ufw deny 6379/tcp

# Change Redis password
systemctl stop redis
# Generate new password
echo "new_password" > /etc/redis/redis.passwd
# Update configuration
systemctl start redis

# Review logs for suspicious activity
grep -i "error\|warning\|failed" /var/log/redis/redis-server.log

# Restart with clean state if needed
systemctl stop redis
rm /var/lib/redis/dump.rdb
systemctl start redis
```

### Data Recovery
```bash
# Stop Redis service
systemctl stop redis

# Restore from latest backup
redis-backup restore <backup_date>

# Verify data integrity
redis-cli -a <PASSWORD> info keyspace

# Restart monitoring
systemctl enable redis
```

## Compliance Notes

### Industry Standards
- **CIS Redis Benchmark**: Configuration aligns with CIS recommendations
- **NIST Cybersecurity Framework**: Implements access control and monitoring
- **GDPR**: Data processing within controlled environment
- **SOC 2**: Security controls for internal services

### Audit Trail
- All Redis operations logged to system journal
- Connection attempts logged to Redis log
- Authentication failures tracked
- Performance metrics collected
- Backup operations logged

## Performance Considerations

### Resource Limits
```bash
# Set memory limits
echo "redis soft memlock 256000" >> /etc/security/limits.conf
echo "redis hard memlock 256000" >> /etc/security/limits.conf

# Configure systemd limits
systemctl edit redis
# Add:
# [Service]
# MemoryLimit=512M
```

### Monitoring Metrics
- Memory usage and fragmentation
- Connection count and client types
- Command execution rates
- Slow query frequency
- Persistence operation performance
- Network I/O statistics

## Advanced Security Features

### TLS Configuration (Optional)
```bash
# Generate certificates
openssl genrsa -out /etc/redis/redis.key 2048
openssl req -new -x509 -key /etc/redis/redis.key -out /etc/redis/redis.crt -days 365

# Update Redis configuration
tls-port 0
tls-cert-file /etc/redis/redis.crt
tls-key-file /etc/redis/redis.key
tls-ca-cert-file /etc/redis/ca.crt
```

### Redis Modules Security
```bash
# Load secure modules only
loadmodule /usr/local/lib/redis-modules/redistimeseries.so
loadmodule /usr/local/lib/redis-modules/redisjson.so

# Verify module permissions
ls -la /usr/local/lib/redis-modules/
```

This Redis security configuration provides comprehensive protection for localhost-only deployments while maintaining high performance and reliability.
