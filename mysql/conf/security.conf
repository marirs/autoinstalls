# MySQL/MariaDB Security Configuration
# Localhost-only MySQL/MariaDB deployment with comprehensive security hardening

## MySQL Configuration File
# File: /etc/mysql/my.cnf

# Client Configuration
[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
default-character-set = utf8mb4

# MySQL CLI Configuration
[mysql]
default-character-set = utf8mb4

# MySQL Server Configuration
[mysqld]
# Basic Settings
user = mysql
pid-file = /var/run/mysqld/mysqld.pid
socket = /var/run/mysqld/mysqld.sock
port = 3306
basedir = /usr
datadir = /var/lib/mysql
tmpdir = /tmp
lc-messages-dir = /usr/share/mysql
skip-external-locking

# Network Security
bind-address = 127.0.0.1
skip-networking = false
skip-name-resolve

# Character Set Configuration
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# Security Settings
skip-show-database = 1
local-infile = 0

# Logging Configuration
log-error = /var/log/mysql/error.log
slow-query-log = 1
slow-query-log-file = /var/log/mysql/slow.log
long_query_time = 2
log-queries-not-using-indexes = 1

# Performance Settings
key_buffer_size = 32M
max_allowed_packet = 64M
table_open_cache = 256
sort_buffer_size = 1M
read_buffer_size = 1M
read_rnd_buffer_size = 4M
myisam_sort_buffer_size = 64M
thread_cache_size = 8
query_cache_size = 16M
query_cache_type = 1

# InnoDB Settings
innodb_buffer_pool_size = 128M
innodb_log_file_size = 32M
innodb_flush_method = O_DIRECT
innodb_file_per_table = 1
innodb_flush_log_at_trx_commit = 1

# Connection Settings
max_connections = 100
max_connect_errors = 1000
wait_timeout = 28800
interactive_timeout = 28800

# Memory Settings
max_heap_table_size = 16M
tmp_table_size = 16M

# Binary Logging
log-bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# mysqldump Configuration
[mysqldump]
quick
quote-names
max_allowed_packet = 64M

# mysqlhotcopy Configuration
[mysqlhotcopy]
interactive-timeout

# isamchk Configuration
[isamchk]
key_buffer_size = 16M
sort_buffer_size = 20M
read_buffer = 2M
write_buffer = 2M

# myisamchk Configuration
[myisamchk]
key_buffer_size = 20M
sort_buffer_size = 20M
read_buffer = 2M
write_buffer = 2M

## Security Features Explained:

### 1. Network Security
- **bind-address = 127.0.0.1**: MySQL only listens on localhost
- **skip-name-resolve**: Disables DNS lookups for security
- **skip-networking = false**: Allows local connections while maintaining security

### 2. Authentication Security
- **skip-show-database = 1**: Prevents users from seeing all databases
- **local-infile = 0**: Disables LOAD DATA LOCAL INFILE for security

### 3. Character Set Security
- **utf8mb4**: Full Unicode support including emojis
- **utf8mb4_unicode_ci**: Case-insensitive Unicode collation

### 4. Performance and Memory Security
- **Memory limits**: Prevents memory exhaustion attacks
- **Connection limits**: Controls resource usage
- **Query cache**: Improves performance while maintaining security

## Firewall Configuration

### UFW Rules
```bash
# Allow MySQL from localhost only
ufw allow from 127.0.0.1 to any port 3306
ufw allow from ::1 to any port 3306

# Block external MySQL access
ufw deny 3306/tcp
```

### iptables Rules (Alternative)
```bash
# Allow MySQL from localhost only
iptables -A INPUT -p tcp --dport 3306 -s 127.0.0.1 -j ACCEPT
iptables -A INPUT -p tcp --dport 3306 -s ::1 -j ACCEPT

# Block external MySQL access
iptables -A INPUT -p tcp --dport 3306 -j DROP
```

## Systemd Security Configuration

### MySQL Service Security
```ini
[Unit]
Description=MySQL Community Server
After=network.target

[Service]
Type=notify
User=mysql
Group=mysql

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ReadWritePaths=/var/lib/mysql /var/log/mysql /etc/mysql /var/run/mysqld
ProtectHome=true
RemoveIPC=true

# Network settings
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
IPAddressDeny=any
IPAddressAllow=localhost
IPAddressAllow=127.0.0.1/8
IPAddressAllow=::1/128

# File system settings
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true

# Memory settings
MemoryMax=1G

# MySQL specific settings
ExecStart=/usr/sbin/mysqld
ExecReload=/bin/kill -HUP $MAINPID
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
```

## Security Best Practices

### 1. Password Management
```bash
# Generate secure password
openssl rand -base64 32 | tr -d "=+/" | cut -c1-25

# Store password securely
chmod 600 /etc/mysql/mysql.root.passwd
chown root:root /etc/mysql/mysql.root.passwd
```

### 2. Connection Security
```bash
# Connect with authentication
mysql -u root -p<password>

# Test connection
mysql -u root -p<password> -e "SELECT VERSION();"

# Use environment variable for password
export MYSQL_PASSWORD=<password>
mysql -u root -p$MYSQL_PASSWORD
```

### 3. Application Security
```python
# Python example with mysql-connector-python
import mysql.connector

# Secure connection with authentication
conn = mysql.connector.connect(
    host='localhost',
    port=3306,
    user='root',
    password='<password>',
    database='mydatabase',
    charset='utf8mb4',
    autocommit=True
)

# Test connection
cursor = conn.cursor()
cursor.execute("SELECT VERSION()")
version = cursor.fetchone()
print(f"MySQL version: {version[0]}")
```

```javascript
// Node.js example with mysql2
const mysql = require('mysql2');

const connection = mysql.createConnection({
    host: 'localhost',
    port: 3306,
    user: 'root',
    password: '<password>',
    database: 'mydatabase',
    charset: 'utf8mb4'
});

// Test connection
connection.connect((err) => {
    if (err) throw err;
    console.log('Connected to MySQL');
});
```

## Monitoring and Auditing

### 1. Connection Monitoring
```bash
# Monitor connected users
mysql -u root -p<password> -e "SHOW PROCESSLIST;"

# Monitor connection statistics
mysql -u root -p<password> -e "SHOW STATUS LIKE 'Connections';"

# Check current connections
mysql -u root -p<password> -e "SHOW STATUS LIKE 'Threads_connected';"
```

### 2. Security Monitoring
```bash
# Check failed login attempts
grep "Access denied" /var/log/mysql/error.log

# Monitor authentication attempts
grep "authentication" /var/log/mysql/error.log

# Check for suspicious activity
grep -i "error\|warning\|failed" /var/log/mysql/error.log
```

### 3. Performance Monitoring
```bash
# Check server status
mysql -u root -p<password> -e "SHOW STATUS;"

# Check slow queries
mysql -u root -p<password> -e "SHOW SLOW LOG;"

# Check database sizes
mysql -u root -p<password> -e "SELECT table_schema AS 'Database', ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'Size (MB)' FROM information_schema.tables GROUP BY table_schema;"
```

## Backup and Recovery

### 1. Automated Backup
```bash
# Create backup script
#!/bin/bash
MYSQL_PASSWORD=$(cat /etc/mysql/mysql.root.passwd)
BACKUP_DIR="/var/backups/mysql"
DATE=$(date +%Y%m%d_%H%M%S)

# Backup all databases
mysqldump -u root -p$MYSQL_PASSWORD --single-transaction --routines --triggers --all-databases | gzip > $BACKUP_DIR/all_databases_$DATE.sql.gz

# Backup individual databases
databases=$(mysql -u root -p$MYSQL_PASSWORD -e "SHOW DATABASES;" -s -N | grep -v -E "information_schema|performance_schema|mysql|sys")
for db in $databases; do
    mysqldump -u root -p$MYSQL_PASSWORD --single-transaction --routines --triggers $db | gzip > $BACKUP_DIR/${db}_$DATE.sql.gz
done
```

### 2. Restore Procedure
```bash
# Restore all databases
gunzip -c /var/backups/mysql/all_databases_YYYYMMDD_HHMMSS.sql.gz | mysql -u root -p<password>

# Restore specific database
gunzip -c /var/backups/mysql/database_name_YYYYMMDD_HHMMSS.sql.gz | mysql -u root -p<password> database_name
```

## Security Checklist

### ✅ Pre-Installation
- [ ] System updated and patched
- [ ] Firewall installed and configured
- [ ] MySQL user created with minimal privileges
- [ ] Secure password generated

### ✅ Installation
- [ ] MySQL/MariaDB installed from official repository
- [ ] Security configuration applied
- [ ] Root password authentication enabled
- [ ] Anonymous users removed
- [ ] Test database removed
- [ ] Remote root access disabled
- [ ] Firewall rules configured
- [ ] Systemd security applied

### ✅ Post-Installation
- [ ] MySQL service running and enabled
- [ ] Password authentication tested
- [ ] Localhost-only access verified
- [ ] Backup procedures tested
- [ ] Monitoring configured

### ✅ Ongoing Security
- [ ] Regular security updates applied
- [ ] Password rotation schedule
- [ ] Log monitoring for security events
- [ ] Backup verification
- [ ] Performance monitoring
- [ ] Access reviews

## Troubleshooting

### Common Security Issues

#### Authentication Failures
```bash
# Check if password is correct
mysql -u root -p<password> -e "SELECT 1;"

# Check MySQL logs for authentication errors
grep "Access denied" /var/log/mysql/error.log

# Verify password file permissions
ls -la /etc/mysql/mysql.root.passwd
```

#### External Access Attempts
```bash
# Check firewall rules
ufw status verbose

# Check network connections
netstat -tlnp | grep 3306

# Check MySQL configuration
grep "bind-address" /etc/mysql/my.cnf
```

#### Performance Issues
```bash
# Check MySQL status
mysql -u root -p<password> -e "SHOW STATUS;"

# Check slow queries
mysql -u root -p<password> -e "SHOW SLOW LOG;"

# Check connection limits
mysql -u root -p<password> -e "SHOW VARIABLES LIKE 'max_connections';"
```

## Emergency Procedures

### Security Incident Response
```bash
# Block external access immediately
ufw deny 3306/tcp

# Change MySQL root password
systemctl stop mysql
# Generate new password
echo "new_password" > /etc/mysql/mysql.root.passwd
# Update MySQL password
systemctl start mysql
mysql -u root -p"old_password" -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';"

# Review logs for suspicious activity
grep -i "error\|warning\|failed" /var/log/mysql/error.log

# Restart with clean state if needed
systemctl stop mysql
rm -rf /var/lib/mysql/ib_logfile*
systemctl start mysql
```

### Data Recovery
```bash
# Stop MySQL service
systemctl stop mysql

# Restore from latest backup
mysql-backup restore <backup_date>

# Verify data integrity
mysql -u root -p<password> -e "SELECT COUNT(*) FROM information_schema.tables;"

# Restart monitoring
systemctl enable mysql
```

## Compliance Notes

### Industry Standards
- **CIS MySQL Benchmark**: Configuration aligns with CIS recommendations
- **NIST Cybersecurity Framework**: Implements access control and monitoring
- **GDPR**: Data processing within controlled environment
- **SOC 2**: Security controls for internal services

### Audit Trail
- All MySQL operations logged to error log
- Connection attempts logged to MySQL log
- Authentication failures tracked
- Performance metrics collected
- Backup operations logged

## Performance Considerations

### Resource Limits
```bash
# Set memory limits
echo "mysql soft memlock 512000" >> /etc/security/limits.conf
echo "mysql hard memlock 512000" >> /etc/security/limits.conf

# Configure systemd limits
systemctl edit mysql
# Add:
# [Service]
# MemoryLimit=1G
```

### Monitoring Metrics
- Memory usage and buffer pool hit rate
- Connection count and thread usage
- Query execution rates
- Slow query frequency
- Disk I/O statistics
- Network I/O statistics

## Advanced Security Features

### SSL/TLS Configuration (Optional)
```bash
# Generate SSL certificates
openssl genrsa 2048 > ca-key.pem
openssl req -new -x509 -nodes -days 3600 -key ca-key.pem -out ca.pem
openssl req -newkey rsa:2048 -days 3600 -nodes -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 3600 -CA ca.pem -CAkey ca-key.pem -set_serial 01 -out server-cert.pem

# Update MySQL configuration
[mysqld]
ssl-ca=/etc/mysql/certs/ca.pem
ssl-cert=/etc/mysql/certs/server-cert.pem
ssl-key=/etc/mysql/certs/server-key.pem
require_secure_transport=ON
```

### MySQL Users and Privileges
```bash
# Create application user with limited privileges
CREATE USER 'app_user'@'localhost' IDENTIFIED BY 'secure_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON app_database.* TO 'app_user'@'localhost';

# Create backup user
CREATE USER 'backup_user'@'localhost' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES, SHOW VIEW ON *.* TO 'backup_user'@'localhost';

# Create monitoring user
CREATE USER 'monitor_user'@'localhost' IDENTIFIED BY 'monitor_password';
GRANT SELECT ON performance_schema.* TO 'monitor_user'@'localhost';
GRANT SELECT ON information_schema.* TO 'monitor_user'@'localhost';
```

This MySQL/MariaDB security configuration provides comprehensive protection for localhost-only deployments while maintaining high performance and reliability.
