# MongoDB User Management Script
# Create and manage MongoDB users with proper roles

#!/bin/bash

# Configuration
MONGO_HOST="localhost"
MONGO_PORT="27017"
ADMIN_USER="admin"
ADMIN_PASSWORD="your_admin_password"

# Colors
CSI="\033["
CEND="${CSI}0m"
CRED="${CSI}1;31m"
CGREEN="${CSI}1;32m"
CYELLOW="${CSI}1;33m"

# Function to create admin user
create_admin_user() {
    echo "Creating MongoDB admin user..."
    
    mongo --host $MONGO_HOST --port $MONGO_PORT <<EOF
use admin
db.createUser({
  user: "$ADMIN_USER",
  pwd: "$ADMIN_PASSWORD",
  roles: [
    { role: "userAdminAnyDatabase", db: "admin" },
    { role: "dbAdminAnyDatabase", db: "admin" },
    { role: "readWriteAnyDatabase", db: "admin" },
    { role: "clusterAdmin", db: "admin" }
  ]
})
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Admin user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create admin user${CEND}"
        exit 1
    fi
}

# Function to create application user
create_app_user() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: $0 create-app <username> <password> <database>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    DATABASE="$3"
    
    echo "Creating application user: $USERNAME for database: $DATABASE"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use $DATABASE
db.createUser({
  user: "$USERNAME",
  pwd: "$PASSWORD",
  roles: [
    { role: "readWrite", db: "$DATABASE" }
  ]
})
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Application user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create application user${CEND}"
        exit 1
    fi
}

# Function to create read-only user
create_readonly_user() {
    if [ -z "$1" ] || [ -z "$2" ] || [ -z "$3" ]; then
        echo "Usage: $0 create-readonly <username> <password> <database>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    DATABASE="$3"
    
    echo "Creating read-only user: $USERNAME for database: $DATABASE"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use $DATABASE
db.createUser({
  user: "$USERNAME",
  pwd: "$PASSWORD",
  roles: [
    { role: "read", db: "$DATABASE" }
  ]
})
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Read-only user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create read-only user${CEND}"
        exit 1
    fi
}

# Function to create backup user
create_backup_user() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: $0 create-backup <username> <password>"
        exit 1
    fi
    
    USERNAME="$1"
    PASSWORD="$2"
    
    echo "Creating backup user: $USERNAME"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use admin
db.createUser({
  user: "$USERNAME",
  pwd: "$PASSWORD",
  roles: [
    { role: "backup", db: "admin" },
    { role: "clusterMonitor", db: "admin" },
    { role: "read", db: "local" }
  ]
})
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Backup user created successfully${CEND}"
    else
        echo -e "${CRED}Failed to create backup user${CEND}"
        exit 1
    fi
}

# Function to list all users
list_users() {
    echo "Listing MongoDB users..."
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use admin
db.getUsers()
EOF
}

# Function to delete user
delete_user() {
    if [ -z "$1" ]; then
        echo "Usage: $0 delete <username>"
        exit 1
    fi
    
    USERNAME="$1"
    
    echo "Deleting user: $USERNAME"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use admin
db.dropUser("$USERNAME")
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}User deleted successfully${CEND}"
    else
        echo -e "${CRED}Failed to delete user${CEND}"
        exit 1
    fi
}

# Function to change user password
change_password() {
    if [ -z "$1" ] || [ -z "$2" ]; then
        echo "Usage: $0 password <username> <new_password>"
        exit 1
    fi
    
    USERNAME="$1"
    NEW_PASSWORD="$2"
    
    echo "Changing password for user: $USERNAME"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use admin
db.updateUser("$USERNAME", {pwd: "$NEW_PASSWORD"})
EOF
    
    if [ $? -eq 0 ]; then
        echo -e "${CGREEN}Password changed successfully${CEND}"
    else
        echo -e "${CRED}Failed to change password${CEND}"
        exit 1
    fi
}

# Function to check user permissions
check_user_permissions() {
    if [ -z "$1" ]; then
        echo "Usage: $0 check <username>"
        exit 1
    fi
    
    USERNAME="$1"
    
    echo "Checking permissions for user: $USERNAME"
    
    mongo --host $MONGO_HOST --port $MONGO_PORT -u "$ADMIN_USER" -p "$ADMIN_PASSWORD" --authenticationDatabase admin <<EOF
use admin
var user = db.getUser("$USERNAME")
if (user) {
  print("User: " + user[0].user + "\n")
  print("Roles:\n")
  user[0].roles.forEach(function(role) {
    print("  - " + role.role + " on " + role.db + "\n")
  })
} else {
  print("User not found\n")
}
EOF
}

# Main script logic
case "$1" in
    "create-admin")
        create_admin_user
        ;;
    "create-app")
        create_app_user "$2" "$3" "$4"
        ;;
    "create-readonly")
        create_readonly_user "$2" "$3" "$4"
        ;;
    "create-backup")
        create_backup_user "$2" "$3"
        ;;
    "list")
        list_users
        ;;
    "delete")
        delete_user "$2"
        ;;
    "password")
        change_password "$2" "$3"
        ;;
    "check")
        check_user_permissions "$2"
        ;;
    *)
        echo "MongoDB User Management Script"
        echo "Usage: $0 {command} [arguments]"
        echo ""
        echo "Commands:"
        echo "  create-admin                    Create admin user"
        echo "  create-app <user> <pass> <db>     Create application user"
        echo "  create-readonly <user> <pass> <db> Create read-only user"
        echo "  create-backup <user> <pass>       Create backup user"
        echo "  list                           List all users"
        echo "  delete <username>               Delete user"
        echo "  password <username> <new_pass>   Change user password"
        echo "  check <username>                Check user permissions"
        echo ""
        echo "Examples:"
        echo "  $0 create-admin"
        echo "  $0 create-app webapp password123 myapp"
        echo "  $0 create-readonly reader password123 myapp"
        echo "  $0 create-backup backup backup123"
        echo "  $0 list"
        echo "  $0 delete webapp"
        echo "  $0 password webapp newpassword"
        echo "  $0 check webapp"
        exit 1
        ;;
esac
