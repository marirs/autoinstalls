# MongoDB Performance Monitoring
# Configuration for MongoDB monitoring and metrics

# Enable monitoring in MongoDB configuration
# Add to mongod.conf:
# operationProfiling:
#   slowOpThresholdMs: 100
#   mode: slowOp

# Enable database profiler
# Add to mongod.conf:
# setParameter:
#   operationProfiling.slowOpThresholdMs: 100
#   operationProfiling.mode: slowOp

# Create monitoring user (run with mongodb-users script)
# ./mongodb-users create-monitor monitor password123 admin

# Monitoring queries
# Connect to MongoDB and run these queries to get performance metrics
# Use localhost connection: mongo --host 127.0.0.1 --port 27017

# 1. Server status
db.serverStatus()

# 2. Database stats
db.stats()

# 3. Collection stats
db.collection.stats()

# 4. Current operations
db.currentOp()

# 5. Index usage
db.collection.getIndexes()

# 6. Connection status
db.runCommand({serverStatus: 1})

# 7. Replication status (if replica set)
rs.status()

# 8. Sharding status (if sharded)
sh.status()

# 9. Memory usage
db.runCommand({serverStatus: 1}).mem

# 10. Disk usage
db.runCommand({collStats: "collection_name", "storageStats": true})

# Performance monitoring script example:
# Save as monitor-mongodb.sh

#!/bin/bash
MONGO_HOST="127.0.0.1"                    # Use localhost only for security
MONGO_PORT="27017"
MONGO_USER="monitor"
MONGO_PASS="password123"

# Get server status
echo "=== MongoDB Server Status ==="
mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.serverStatus().connections;
db.serverStatus().opcounters;
db.serverStatus().mem;
" --quiet

# Get database stats
echo -e "\n=== Database Statistics ==="
mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.stats()" --quiet

# Get slow operations
echo -e "\n=== Slow Operations ==="
mongo --host $MONGO_HOST --port $ONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.currentOp({\$where: {millis: {\$gt: 100}}})" --quiet

# Get index usage
echo -e "\n=== Index Usage ==="
mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.runCommand({collStats: 'collection_name', indexDetails: true})" --quiet

# Alert thresholds (adjust as needed)
CONNECTIONS_THRESHOLD=80
MEMORY_THRESHOLD=80
SLOW_OP_THRESHOLD=100

# Check alerts
echo -e "\n=== Performance Alerts ==="
# Check connections
CONNECTIONS=$(mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.serverStatus().connections.current" --quiet)
if [ "$CONNECTIONS" -gt "$CONNECTIONS_THRESHOLD" ]; then
    echo "ALERT: High connection count: $CONNECTIONS"
fi

# Check memory usage
MEMORY_USED=$(mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.serverStatus().mem.resident" --quiet)
MEMORY_TOTAL=$(mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.serverStatus().mem.virtual" --quiet)
MEMORY_PERCENT=$((MEMORY_USED * 100 / MEMORY_TOTAL))
if [ "$MEMORY_PERCENT" -gt "$MEMORY_THRESHOLD" ]; then
    echo "ALERT: High memory usage: ${MEMORY_PERCENT}%"
fi

# Check slow operations
SLOW_OPS=$(mongo --host $MONGO_HOST --port $MONGO_PORT -u $MONGO_USER -p $MONGO_PASS --authenticationDatabase admin --eval "
db.currentOp({\$where: {millis: {\$gt: $SLOW_OP_THRESHOLD}}}).length()" --quiet)
if [ "$SLOW_OPS" -gt 0 ]; then
    echo "ALERT: $SLOW_OPS slow operations detected"
fi
